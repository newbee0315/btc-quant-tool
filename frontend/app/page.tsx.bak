'use client';

import React, { useEffect, useRef, useState } from 'react';
import { KlineChart } from '@/components/KlineChart';
import { BacktestPanel } from '@/components/BacktestPanel';
import { PortfolioPanel } from '@/components/PortfolioPanel';
import { EquityHistoryChart, EquityHistoryItem } from '@/components/EquityHistoryChart';
import { PaperTradingPanel, PaperStatus } from '@/components/PaperTradingPanel';
import { NewsCard } from '@/components/NewsCard';
import { MonitoredTickers } from '@/components/MonitoredTickers';
import { UTCTimestamp } from 'lightweight-charts';
import { 
    ArrowUp, ArrowDown, Activity, Clock, BarChart2, TrendingUp, TrendingDown, ChevronDown, ChevronUp, 
    Beaker, Wallet, Settings, DollarSign, Shield, History, CheckCircle2, XCircle, RefreshCw, AlertCircle,
    LayoutGrid, List
} from 'lucide-react';
import { ThemeToggle } from '@/components/theme-toggle';
import axios from 'axios';

interface Trade {
    id: string;
    timestamp: number;
    datetime: string;
    symbol?: string; // Added symbol
    side: 'buy' | 'sell';
    price: number;
    amount: number;
    cost: number;
    fee: {
        cost: number;
        currency: string;
    };
    realized_pnl: number;
    // New fields for Closed Trades
    entry_price?: number;
    exit_price?: number;
    position_side?: 'LONG' | 'SHORT';
    roi?: number;
    entry_time?: number;
}

interface StrategySignal {
    symbol: string;
    timestamp: string;
    price: number;
    avg_probability: number;
    signal: "LONG" | "SHORT" | "NEUTRAL";
    confidence: "HIGH" | "NONE";
    predictions?: {
        "10m"?: number;
        "30m"?: number;
    };
    strategy_result?: {
        reason?: string;
        indicators?: {
            rsi: number;
            ema: number;
            adx: number;
            atr: number;
            macd_hist?: number;
        };
    };
}

interface Position {
    entry_time?: number | string;
    entry_price: number;
    amount: number;
    position_value_usdt?: number;
    side: 'long' | 'short';
    unrealized_pnl: number;
    pnl_pct: number;
    liquidation_price?: number;
    mark_price?: number;
    initial_margin?: number;
    leverage?: number;
    sl_price?: number;
    tp_price?: number;
}

interface StrategyStats {
    win_rate: number;
    total_trades: number;
    total_pnl: number;
    total_fees?: number;
    duration: string;
    start_time: string;
}

interface TraderStatus {
    active: boolean;
    balance: number;
    total_balance: number;
    equity: number;
    unrealized_pnl: number;
    positions: { [key: string]: Position };
    trade_history: Trade[];
    stats: StrategyStats;
    initial_balance: number;
    open_orders_count?: number; // Added
    connection_status?: string;
    connection_error?: string | null;
}

interface SystemStatus {
    trader: TraderStatus;
    mode: 'paper' | 'real';
    strategy: {
        name: string;
        config: any;
        logs: any[];
    };
    server_time: string;
}

interface TickerData {
    timestamp: number;
    datetime: string;
    last: number;
    high: number;
    low: number;
    volume: number;
    price_change?: number;
    price_change_percent?: number;
}

interface FearGreedData {
    value: string;
    value_classification: string;
    timestamp: string;
}

interface KlineData {
    time: UTCTimestamp;
    open: number;
    high: number;
    low: number;
    close: number;
}

interface PredictionResult {
    direction: 'UP' | 'DOWN';
    probability: number;
    confidence: number;
    is_high_confidence: boolean;
}

interface PredictionData {
    symbol: string;
    timestamp: number;
    predictions: {
        [key: string]: PredictionResult; // "10m", "30m", "60m"
    };
}

interface StrategyLog {
    id: string;
    timestamp: number;
    timeString: string;
    direction: 'UP' | 'DOWN';
    entryPrice: number;
    tp: number;
    sl: number;
    horizon: string;
    isHighConf: boolean;
    probability?: number;
    confidence?: number;
    reasons?: string[] | string;
    ema?: number;
    rsi?: number;
    macd_hist?: number;
}

interface BotConfig {
    confidence_threshold: number;
    notification_level: 'ALL' | 'HIGH_ONLY';
}

export default function Home() {
    const [ticker, setTicker] = useState<TickerData | null>(null);
    const [klineData, setKlineData] = useState<KlineData[]>([]);
    const [prediction, setPrediction] = useState<PredictionData | null>(null);
    const [fng, setFng] = useState<FearGreedData | null>(null);
    const [loading, setLoading] = useState(true);
    const [selectedTimeframe, setSelectedTimeframe] = useState('10m');
    const [strategyLogs, setStrategyLogs] = useState<StrategyLog[]>([]);
    const [showAllStrategies, setShowAllStrategies] = useState(false);
    const [isLogsLoaded, setIsLogsLoaded] = useState(false);

    // Monitor State
    const [systemStatus, setSystemStatus] = useState<SystemStatus | null>(null);
    const [monitorLastUpdated, setMonitorLastUpdated] = useState<Date | null>(null);
    const [monitorError, setMonitorError] = useState('');
    const [leverageValue, setLeverageValue] = useState<number>(10);
    const [savingLev, setSavingLev] = useState<boolean>(false);
    const [levMsg, setLevMsg] = useState<string>('');
    const [levSource, setLevSource] = useState<'server' | 'user'>('server');
    const levAutoSaveTimer = useRef<number | null>(null);

    // Backtest Trades State
    const [backtestTrades, setBacktestTrades] = useState<Trade[]>([]);

    // Equity History State
    const [equityHistory, setEquityHistory] = useState<EquityHistoryItem[]>([]);

    const fetchEquityHistory = async () => {
        try {
            const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';
            const res = await axios.get(`${API_URL}/api/v1/equity/history`);
            if (res.data.status === 'success') {
                setEquityHistory(res.data.data);
            }
        } catch (error) {
            console.error('Error fetching equity history:', error);
        }
    };

    const fetchFng = async () => {
        try {
            const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';
            const res = await axios.get(`${API_URL}/api/v1/market/fear-and-greed`);
            if (res.data) {
                setFng(res.data);
            }
        } catch (error) {
            console.error('Error fetching fear and greed:', error);
        }
    };

    useEffect(() => {
        fetchEquityHistory();
        fetchFng();
        const interval = setInterval(() => {
            fetchEquityHistory();
            fetchFng();
        }, 60000); // Poll every minute
        return () => clearInterval(interval);
    }, []);

    const handleBacktestResult = (results: any, trades: any[], equityCurve: any[]) => {
        const processedTrades: Trade[] = [];
        trades.forEach((t: any) => {
            // Entry Marker
            processedTrades.push({
                id: `${t.id}_entry`,
                timestamp: t.entry_time,
                datetime: new Date(t.entry_time).toISOString(),
                side: t.entry_side === 'long' ? 'buy' : 'sell',
                price: t.entry_price,
                amount: t.amount,
                cost: t.amount * t.entry_price,
                fee: { cost: 0, currency: 'USDT' }, 
                realized_pnl: 0
            });
            // Exit Marker
            processedTrades.push({
                id: `${t.id}_exit`,
                timestamp: t.timestamp,
                datetime: t.datetime,
                side: t.side as 'buy' | 'sell', 
                price: t.price,
                amount: t.amount,
                cost: t.amount * t.price,
                fee: { cost: typeof t.fee === 'number' ? t.fee : t.fee?.cost || 0, currency: 'USDT' },
                realized_pnl: t.realized_pnl
            });
        });
        setBacktestTrades(processedTrades);
    };

    // Load strategy logs from localStorage on mount
    useEffect(() => {
        const savedLogs = localStorage.getItem('strategyLogs');
        if (savedLogs) {
            try {
                setStrategyLogs(JSON.parse(savedLogs));
            } catch (e) {
                console.error("Failed to parse strategy logs", e);
            }
        }
        setIsLogsLoaded(true);
    }, []);

    // Save strategy logs to localStorage whenever they change
    useEffect(() => {
        if (isLogsLoaded) {
            localStorage.setItem('strategyLogs', JSON.stringify(strategyLogs));
        }
    }, [strategyLogs, isLogsLoaded]);

    useEffect(() => {
        try {
            const saved = localStorage.getItem('maxPortfolioLeverage') || localStorage.getItem('strategyLeverage');
            if (saved) {
                const v = parseInt(saved, 10);
                if (!isNaN(v)) setLeverageValue(Math.max(1, Math.min(10, v)));
            }
        } catch {}
    }, []);

    // Auto-save leverage with 500ms debounce when changed by user
    useEffect(() => {
        if (levSource !== 'user') return;
        if (levAutoSaveTimer.current) {
            clearTimeout(levAutoSaveTimer.current);
        }
        levAutoSaveTimer.current = window.setTimeout(async () => {
            try {
                setSavingLev(true);
                setLevMsg('保存中...');
                const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';
                const currentCfg = (systemStatus && systemStatus.strategy && systemStatus.strategy.config) ? systemStatus.strategy.config : {};
                const payload = {
                    ema_period: currentCfg.ema_period ?? 200,
                    rsi_period: currentCfg.rsi_period ?? 14,
                    ml_threshold: currentCfg.ml_threshold ?? 0.8,
                    leverage: currentCfg.leverage ?? 1,
                    max_portfolio_leverage: Math.max(1, Math.min(10, leverageValue))
                };
                await axios.post(`${API_URL}/api/v1/config/strategy`, payload, { timeout: 10000 });
                try { localStorage.setItem('maxPortfolioLeverage', String(Math.max(1, Math.min(10, leverageValue)))); } catch {}
                setLevMsg('已保存');
                await fetchStatus();
            } catch (e) {
                setLevMsg('保存失败');
            } finally {
                setSavingLev(false);
                setLevSource('server');
                window.setTimeout(() => setLevMsg(''), 1500);
            }
        }, 500);
        return () => {
            if (levAutoSaveTimer.current) {
                clearTimeout(levAutoSaveTimer.current);
            }
        };
    }, [leverageValue, levSource]);

    // Monitor Fetch Logic
    const fetchStatus = async () => {
        try {
            const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';
            const res = await axios.get(`${API_URL}/api/v1/status`);
            setSystemStatus(res.data);
            const lev = res.data?.strategy?.config?.max_portfolio_leverage ?? res.data?.strategy?.config?.leverage;
            if (typeof lev === 'number') {
                const clamped = Math.max(1, Math.min(10, lev));
                setLevSource('server');
                setLeverageValue(clamped);
            }
            
            // Sync strategy logs from backend (Source of Truth for reasons)
            if (res.data.strategy && res.data.strategy.logs && res.data.strategy.logs.length > 0) {
                 const backendLogs = res.data.strategy.logs.map((log: any) => ({
                    id: `${log.timestamp}-${log.signal}`,
                    timestamp: new Date(log.timestamp).getTime(),
                    timeString: new Date(log.timestamp).toLocaleString('zh-CN', { 
                        month: '2-digit', 
                        day: '2-digit', 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        second: '2-digit',
                        hour12: false
                    }),
                    direction: log.signal === 1 ? 'UP' : (log.signal === -1 ? 'DOWN' : 'NONE'),
                    entryPrice: log.close,
                    tp: log.tp,
                    sl: log.sl,
                    horizon: '30m', 
                    isHighConf: Math.abs(log.ml_prob - 0.5) > 0.2, 
                    probability: log.ml_prob,
                    confidence: log.ml_prob > 0.5 ? log.ml_prob : 1 - log.ml_prob,
                    reasons: log.reasons,
                    ema: log.ema,
                    rsi: log.rsi,
                    macd_hist: log.macd_hist
                 }));
                 // Merge with existing logs to keep history if needed, but backend usually returns full history (50 items)
                 // So we can just replace.
                 setStrategyLogs(backendLogs);
            }

            setMonitorLastUpdated(new Date());
            setMonitorError('');
        } catch (err) {
            console.error("Failed to fetch status:", err);
            setMonitorError('无法连接到策略引擎');
        }
    };

    useEffect(() => {
        fetchStatus();
        const interval = setInterval(fetchStatus, 6000); // Poll every 6 seconds to reduce load
        return () => clearInterval(interval);
    }, []);

    const [showBacktest, setShowBacktest] = useState(false);
    const [showPortfolio, setShowPortfolio] = useState(false);
    
    // Strategy Signals State (All Coins)
    const [strategySignals, setStrategySignals] = useState<StrategySignal[]>([]);
    const [signalSearch, setSignalSearch] = useState('');
    const [signalFilter, setSignalFilter] = useState('ALL');
    const [signalsLoading, setSignalsLoading] = useState(true);
    const [signalsError, setSignalsError] = useState('');

    const filteredSignals = strategySignals.filter(s => {
        const matchesSearch = s.symbol.toLowerCase().includes(signalSearch.toLowerCase());
        let matchesFilter = true;
        
        if (signalFilter === 'ACTION') matchesFilter = s.signal === 'LONG' || s.signal === 'SHORT';
        else if (signalFilter === 'LONG') matchesFilter = s.signal === 'LONG';
        else if (signalFilter === 'SHORT') matchesFilter = s.signal === 'SHORT';
        else if (signalFilter === 'HIGH_CONF') matchesFilter = s.confidence === 'HIGH';
        
        return matchesSearch && matchesFilter;
    });

    const fetchStrategySignals = async () => {
        try {
            setSignalsError('');
            const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';
            const res = await axios.get(`${API_URL}/api/v1/strategy/signals`);
            if (res.data.status === 'success') {
                setStrategySignals(res.data.data);
            } else {
                setSignalsError('API Error: ' + res.data.message);
            }
            setSignalsLoading(false);
        } catch (error: any) {
            console.error('Error fetching strategy signals:', error);
            setSignalsError('Failed to load signals');
            setSignalsLoading(false);
        }
    };

    useEffect(() => {
        fetchStrategySignals();
        const interval = setInterval(fetchStrategySignals, 10000); // Poll every 10 seconds
        return () => clearInterval(interval);
    }, []);
    
    // MA Data States
    const [ma7Data, setMa7Data] = useState<{time: UTCTimestamp, value: number}[]>([]);
    const [ma25Data, setMa25Data] = useState<{time: UTCTimestamp, value: number}[]>([]);
    const [ma99Data, setMa99Data] = useState<{time: UTCTimestamp, value: number}[]>([]);

    // Bot Config State
    const [botConfig, setBotConfig] = useState<BotConfig>({ confidence_threshold: 0.7, notification_level: 'HIGH_ONLY' });
    const [showConfig, setShowConfig] = useState(false);

    const fetchBotConfig = React.useCallback(async () => {
        try {
            const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';
            const res = await axios.get(`${API_URL}/api/v1/bot/config`);
            if (res.data) setBotConfig(res.data);
        } catch (e) {
            console.error("Failed to fetch bot config", e);
        }
    }, []);

    const updateBotConfig = async (newConfig: BotConfig) => {
        try {
            // Optimistic update
            setBotConfig(newConfig);
            const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';
            await axios.post(`${API_URL}/api/v1/bot/config`, newConfig);
        } catch (e) {
            console.error("Failed to update bot config", e);
            fetchBotConfig(); // Revert on error
        }
    };

    const calculateSMA = React.useCallback((data: KlineData[], period: number) => {
        const result = [];
        for (let i = 0; i < data.length; i++) {
            if (i < period - 1) continue;
            let sum = 0;
            for (let j = 0; j < period; j++) {
                sum += data[i - j].close;
            }
            result.push({
                time: data[i].time,
                value: sum / period,
            });
        }
        return result;
    }, []);

    // Process strategy logs logic extracted for reuse
    // DEPRECATED: We now use backend logs (via fetchStatus) to ensure reasons/notes are included.
    const processStrategyLogs = React.useCallback((currentPred: PredictionData, currentTicker: TickerData) => {
        // Disabled to prevent overwriting backend logs with local incomplete logs
        return;
        /*
        if (currentTicker && currentPred && currentPred.predictions) {
            setStrategyLogs(prevLogs => {
                const lastLog = prevLogs[0];
                if (lastLog && lastLog.timestamp === currentPred.timestamp) {
                    return prevLogs;
                }

                // Generate new strategy log
                const p60 = currentPred.predictions['60m'];
                const p30 = currentPred.predictions['30m'];
                const p10 = currentPred.predictions['10m'];
                
                let activeSignal = null;
                let timeHorizon = '';
                
                if (p60?.is_high_confidence) { activeSignal = p60; timeHorizon = '60m'; }
                else if (p30?.is_high_confidence) { activeSignal = p30; timeHorizon = '30m'; }
                else if (p10?.is_high_confidence) { activeSignal = p10; timeHorizon = '10m'; }
                else { activeSignal = p60; timeHorizon = '60m'; }

                if (!activeSignal) return prevLogs;

                const isBullish = activeSignal.direction === 'UP';
                const currentPrice = currentTicker.last;
                const slPercent = 0.03;  // SL 3.0%
                const tpPercent = 0.025; // TP 2.5%

                const newLog: StrategyLog = {
                    id: `${currentPred.timestamp}-${timeHorizon}`,
                    timestamp: currentPred.timestamp,
                    timeString: new Date().toLocaleString('zh-CN', { 
                        month: '2-digit', 
                        day: '2-digit', 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        second: '2-digit',
                        hour12: false
                    }),
                    direction: activeSignal.direction,
                    entryPrice: currentPrice,
                    tp: isBullish ? currentPrice * (1 + tpPercent) : currentPrice * (1 - tpPercent),
                    sl: isBullish ? currentPrice * (1 - slPercent) : currentPrice * (1 + slPercent),
                    horizon: timeHorizon,
                    isHighConf: activeSignal.is_high_confidence,
                    probability: activeSignal.probability,
                    confidence: activeSignal.confidence
                };

                return [newLog, ...prevLogs].slice(0, 50); // Keep last 50
            });
        }
        */
    }, []);

    const fetchData = React.useCallback(async () => {
        try {
            const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';
            
            // Parallelize requests to improve loading speed
            const [tickerRes, historyRes, predRes] = await Promise.all([
                axios.get(`${API_URL}/api/v1/ticker`),
                axios.get(`${API_URL}/api/v1/history?limit=200&timeframe=${selectedTimeframe}`),
                axios.get(`${API_URL}/api/v1/predict`).catch(e => {
                    console.warn("Prediction API not ready yet");
                    return { data: null };
                })
            ]);
            
            if (predRes.data) {
                setPrediction(predRes.data);
                
                // Update Strategy Logs
                processStrategyLogs(predRes.data, tickerRes.data);
            }

            setTicker(tickerRes.data);
            
            // Transform data for lightweight-charts
            const formattedData = historyRes.data.map((item: any) => ({
                time: (item.timestamp / 1000) as UTCTimestamp,
                open: item.open,
                high: item.high,
                low: item.low,
                close: item.close,
            }));
            
            setKlineData(formattedData);
            
            if (formattedData.length > 0) {
                setMa7Data(calculateSMA(formattedData, 7));
                setMa25Data(calculateSMA(formattedData, 25));
                setMa99Data(calculateSMA(formattedData, 99));
            }

            setLoading(false);
        } catch (error) {
            console.error("Failed to fetch data:", error);
            setLoading(false);
        }
    }, [selectedTimeframe, calculateSMA, processStrategyLogs]);

    useEffect(() => {
        fetchData();
        fetchBotConfig();
        
        const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';
        const WS_URL = API_URL.replace('http', 'ws') + '/ws';
        const ws = new WebSocket(WS_URL);
        
        ws.onopen = () => {
            console.log('Connected to WebSocket');
        };

        ws.onmessage = (event) => {
            try {
                const message = JSON.parse(event.data);
                if (message.type === 'ticker_update') {
                    const newTicker = message.data;
                    const newPredictions = message.predictions;
                    
                    setTicker(newTicker);
                    
                    if (newPredictions) {
                        const predData = {
                            symbol: 'BTCUSDT',
                            timestamp: Date.now(), // or server_time if available
                            predictions: newPredictions
                        };
                        setPrediction(predData);
                        processStrategyLogs(predData, newTicker);
                    }
                    
                    // Update last candle in chart for real-time effect
                    setKlineData(prevData => {
                        if (prevData.length === 0) return prevData;
                        const lastCandle = prevData[prevData.length - 1];
                        const newClose = newTicker.last;
                        
                        // Update high/low/close of the last candle
                        const updatedCandle = {
                            ...lastCandle,
                            close: newClose,
                            high: Math.max(lastCandle.high, newClose),
                            low: Math.min(lastCandle.low, newClose)
                        };
                        
                        return [...prevData.slice(0, -1), updatedCandle];
                    });
                }
            } catch (e) {
                console.error("WS Parse Error", e);
            }
        };

        const interval = setInterval(fetchData, 10000); // Poll every 10s for chart data updates
        
        return () => {
            clearInterval(interval);
            ws.close();
        };
    }, [fetchData, fetchBotConfig, processStrategyLogs]);

    // Monitor Helpers
    const trader = systemStatus?.trader;
    const isReal = systemStatus?.mode === 'real';
    const pnlColor = (trader?.stats.total_pnl || 0) >= 0 ? 'text-[#0ECB81]' : 'text-[#F6465D]';
    const pnlSign = (trader?.stats.total_pnl || 0) >= 0 ? '+' : '';
    const unrealizedPnlColor = (trader?.unrealized_pnl || 0) >= 0 ? 'text-[#0ECB81]' : 'text-[#F6465D]';
    const unrealizedPnlSign = (trader?.unrealized_pnl || 0) >= 0 ? '+' : '';
    const roi = trader && trader.initial_balance > 0 ? (trader.stats.total_pnl / trader.initial_balance) * 100 : 0;
    const roiColor = roi >= 0 ? 'text-[#0ECB81]' : 'text-[#F6465D]';

    // Calculate Total Position Value
    const totalPositionValue = trader?.positions 
        ? Object.values(trader.positions).reduce((sum, pos) => sum + (pos.position_value_usdt || 0), 0) 
        : 0;

    return (
        <div className="min-h-screen bg-[#0E1117] text-[#FAFAFA] font-sans flex flex-col">
            {/* Header */}
            <header className="border-b border-[#2B3139] px-4 py-3 md:px-6 md:py-4 flex justify-between items-center bg-[#161A25]">
                <div className="flex items-center gap-2 md:gap-3">
                    <div className="bg-[#F0B90B] p-1.5 rounded-lg">
                        <Activity className="w-4 h-4 md:w-5 md:h-5 text-black" />
                    </div>
                    <div>
                        <h1 className="text-lg md:text-xl font-bold tracking-tight">BTC Quant Pro</h1>
                        <p className="text-[10px] md:text-xs text-[#848E9C]">AI-Powered Market Analysis</p>
                    </div>
                </div>
                <div className="flex items-center gap-2 md:gap-4">
                    {/* Connection Status Indicator */}
                    <div className="flex flex-col items-end group relative mr-2">
                        <div className="flex items-center gap-1.5 cursor-help">
                            <div className={`w-2 h-2 rounded-full ${
                                trader?.connection_status === 'Connected' ? 'bg-[#0ECB81] animate-pulse' : 
                                trader?.connection_status === 'Error' ? 'bg-[#F6465D]' : 'bg-[#F0B90B]'
                            }`}></div>
                            <span className={`text-xs font-medium ${
                                trader?.connection_status === 'Connected' ? 'text-[#0ECB81]' : 
                                trader?.connection_status === 'Error' ? 'text-[#F6465D]' : 'text-[#F0B90B]'
                            }`}>
                                {trader?.connection_status === 'Connected' ? '已连接' : 
                                 trader?.connection_status === 'Error' ? (monitorError && monitorError.includes('418') ? 'IP Banned (Resting)' : '连接错误') : 
                                 '连接中...'}
                            </span>
                        </div>
                        {trader?.connection_error && (
                            <div className="absolute top-full right-0 mt-2 p-2 bg-[#1E2329] border border-red-900/50 rounded shadow-xl text-xs text-[#F6465D] w-64 z-50 hidden group-hover:block">
                                {trader.connection_error}
                            </div>
                        )}
                    </div>

                    <button 
                        onClick={() => setShowBacktest(true)}
                        className="flex items-center gap-2 px-2 py-1.5 md:px-3 bg-[#2B3139] hover:bg-[#363C45] text-[#EAECEF] text-xs md:text-sm font-medium rounded-lg transition-colors border border-[#474D57]"
                    >
                        <Beaker className="w-3 h-3 md:w-4 md:h-4 text-[#F0B90B]" />
                        <span className="hidden sm:inline">Backtest</span>
                    </button>
                    <button 
                        onClick={() => setShowPortfolio(true)}
                        className="flex items-center gap-2 px-2 py-1.5 md:px-3 bg-[#2B3139] hover:bg-[#363C45] text-[#EAECEF] text-xs md:text-sm font-medium rounded-lg transition-colors border border-[#474D57]"
                    >
                        <LayoutGrid className="w-3 h-3 md:w-4 md:h-4 text-[#F0B90B]" />
                        <span className="hidden sm:inline">Portfolio</span>
                    </button>
                    <a href="/data" className="hidden md:block text-sm text-[#848E9C] hover:text-[#F0B90B] transition-colors">
                        Data Info
                    </a>
                    <a href="/models" className="hidden md:block text-sm text-[#848E9C] hover:text-[#F0B90B] transition-colors">
                        Model Info
                    </a>
                    <ThemeToggle />
                    <div className="flex items-center gap-2 px-2 py-1 md:px-3 md:py-1.5 bg-[#1E2329] rounded-full border border-[#2B3139]">
                        <span className="w-1.5 h-1.5 md:w-2 md:h-2 bg-[#0ECB81] rounded-full animate-pulse"></span>
                        <span className="text-[10px] md:text-xs font-medium text-[#0ECB81] whitespace-nowrap">
                            {isReal ? 'REAL TRADING' : 'PAPER TRADING'}
                        </span>
                    </div>
                </div>
            </header>

            <main className="flex-1 p-4 md:p-6 space-y-6 overflow-y-auto bg-[#161A1E]">
                {/* Top Metrics Row */}
                <div className="grid grid-cols-1 lg:grid-cols-5 gap-4">
                    <div className="lg:col-span-4 h-[160px]">
                        <MonitoredTickers />
                    </div>
                    <div className="lg:col-span-1 h-[160px] bg-[#1E2329] p-4 rounded-xl border border-[#2B3139] shadow-sm hover:border-[#474D57] transition-colors flex flex-col justify-center">
                        <p className="text-[#848E9C] text-xs font-medium uppercase mb-3">Fear & Greed Index</p>
                        <div className="flex flex-col gap-2">
                             <span className={`text-4xl font-bold ${
                                fng ? (parseInt(fng.value) > 50 ? 'text-[#0ECB81]' : 'text-[#F6465D]') : 'text-[#F0B90B]'
                            }`}>
                                {fng ? fng.value : '---'}
                            </span>
                            <span className={`text-sm font-medium px-2 py-1 rounded w-fit ${
                                fng ? (parseInt(fng.value) > 50 ? 'bg-[#0ECB81]/10 text-[#0ECB81]' : 'bg-[#F6465D]/10 text-[#F6465D]') : 'bg-[#F0B90B]/10 text-[#F0B90B]'
                            }`}>
                                {fng ? fng.value_classification : 'Loading...'}
                            </span>
                        </div>
                        <p className="text-[10px] text-[#848E9C] mt-4">
                            Next Update: {fng ? new Date(parseInt(fng.timestamp) * 1000 + 86400000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--:--'}
                        </p>
                    </div>
                </div>

                {/* Equity History & News Section */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                    {/* Equity History */}
                    {equityHistory.length > 0 ? (
                        <div className="h-[300px]">
                            <EquityHistoryChart data={equityHistory} />
                        </div>
                    ) : (
                         <div className="h-[300px] bg-[#1E2329] rounded-xl border border-[#2B3139] flex items-center justify-center text-[#848E9C]">
                            Loading Equity History...
                        </div>
                    )}
                    
                    {/* News Card */}
                    <div className="h-[300px]">
                        <NewsCard />
                    </div>
                </div>

                {/* Strategy Monitor Section (New) */}
                <div className="mt-6">
                    <div className="flex items-center justify-between mb-4 px-1">
                        <h2 className="text-xl font-bold flex items-center gap-2 text-[#EAECEF]">
                            <LayoutGrid className="w-5 h-5 text-[#F0B90B]" />
                            Dashboard Overview
                        </h2>
                        <span className="text-xs text-[#848E9C] bg-[#1E2329] px-2 py-1 rounded border border-[#2B3139]">
                            Last Updated: {monitorLastUpdated ? monitorLastUpdated.toLocaleTimeString() : '--:--:--'}
                        </span>
                    </div>

                    {/* KPI Grid */}
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
                        {/* Total Capital */}
                        <div className="bg-[#1E2329] p-4 rounded-xl border border-[#2B3139] relative overflow-hidden shadow-md hover:scale-[1.02] transition-transform duration-200">
                            <div className="absolute top-0 right-0 p-3 opacity-10">
                                <DollarSign className="w-12 h-12 text-[#EAECEF]" />
                            </div>
                            <p className="text-[#848E9C] text-xs font-medium uppercase mb-2">Total Equity</p>
                            <h3 className="text-2xl font-bold font-mono tracking-tight text-[#EAECEF]">
                                ${trader?.equity ? trader.equity.toFixed(2) : '---'}
                            </h3>
                            <p className="text-xs text-[#848E9C] mt-1">
                                Initial: ${trader?.initial_balance ? trader.initial_balance.toFixed(2) : '---'}
                            </p>
                        </div>

                        {/* Total Position Value (New) */}
                        <div className="bg-[#1E2329] p-4 rounded-xl border border-[#2B3139] relative overflow-hidden shadow-md hover:scale-[1.02] transition-transform duration-200">
                            <div className="absolute top-0 right-0 p-3 opacity-10">
                                <Wallet className="w-12 h-12 text-[#EAECEF]" />
                            </div>
                            <p className="text-[#848E9C] text-xs font-medium uppercase mb-2">Total Position Value</p>
                            <h3 className="text-2xl font-bold font-mono tracking-tight text-[#F0B90B]">
                                ${totalPositionValue.toFixed(2)}
                            </h3>
                            <p className="text-xs text-[#848E9C] mt-1">
                                Active Positions Exposure
                            </p>
                        </div>

                        {/* Unrealized PnL (New) */}
                        <div className="bg-[#1E2329] p-4 rounded-xl border border-[#2B3139] relative overflow-hidden shadow-md hover:scale-[1.02] transition-transform duration-200">
                            <div className="absolute top-0 right-0 p-3 opacity-10">
                                <Activity className="w-12 h-12 text-[#EAECEF]" />
                            </div>
                            <p className="text-[#848E9C] text-xs font-medium uppercase mb-2">Unrealized PnL</p>
                            <h3 className={`text-2xl font-bold font-mono tracking-tight ${unrealizedPnlColor}`}>
                                {unrealizedPnlSign}${trader?.unrealized_pnl ? trader.unrealized_pnl.toFixed(2) : '0.00'}
                            </h3>
                            <p className="text-xs text-[#848E9C] mt-1">
                                Open Positions PnL
                            </p>
                        </div>

                        {/* Total PnL */}
                        <div className="bg-[#1E2329] p-4 rounded-xl border border-[#2B3139] relative overflow-hidden shadow-md hover:scale-[1.02] transition-transform duration-200">
                            <div className="absolute top-0 right-0 p-3 opacity-10">
                                <TrendingUp className="w-12 h-12 text-[#EAECEF]" />
                            </div>
                            <p className="text-[#848E9C] text-xs font-medium uppercase mb-2">Total Realized PnL</p>
                            <h3 className={`text-2xl font-bold font-mono tracking-tight ${pnlColor}`}>
                                {pnlSign}${trader?.stats.total_pnl ? trader.stats.total_pnl.toFixed(2) : '---'}
                            </h3>
                            <p className={`text-xs mt-1 font-medium ${roiColor}`}>
                                {pnlSign}{roi.toFixed(2)}% ROI
                            </p>
                            <p className="text-xs text-[#848E9C] mt-0.5">
                                Fees: ${trader?.stats.total_fees ? trader.stats.total_fees.toFixed(2) : '0.00'}
                            </p>
                        </div>

                        {/* Win Rate */}
                        <div className="bg-[#1E2329] p-4 rounded-xl border border-[#2B3139] relative overflow-hidden shadow-md hover:scale-[1.02] transition-transform duration-200">
                            <div className="absolute top-0 right-0 p-3 opacity-10">
                                <CheckCircle2 className="w-12 h-12 text-[#EAECEF]" />
                            </div>
                            <p className="text-[#848E9C] text-xs font-medium uppercase mb-2">Win Rate (All Time)</p>
                            <h3 className="text-2xl font-bold font-mono tracking-tight text-[#F0B90B]">
                                {trader?.stats.win_rate !== undefined ? trader.stats.win_rate.toFixed(1) : '---'}%
                            </h3>
                            <p className="text-xs text-[#848E9C] mt-1">
                                {trader?.stats.total_trades || 0} Trades
                            </p>
                        </div>

                        {/* Open Orders (New) */}
                        <div className="bg-[#1E2329] p-4 rounded-xl border border-[#2B3139] relative overflow-hidden shadow-md hover:scale-[1.02] transition-transform duration-200">
                            <div className="absolute top-0 right-0 p-3 opacity-10">
                                <List className="w-12 h-12 text-[#EAECEF]" />
                            </div>
                            <p className="text-[#848E9C] text-xs font-medium uppercase mb-2">Open Orders</p>
                            <h3 className="text-2xl font-bold font-mono tracking-tight text-[#EAECEF]">
                                {trader?.open_orders_count !== undefined ? trader.open_orders_count : 0}
                            </h3>
                            <p className="text-xs text-[#848E9C] mt-1">
                                Active / Algo
                            </p>
                        </div>

                        
                    </div>

                    {/* Active Position Summary */}
                    <div className="bg-[#1E2329] p-4 rounded-xl border border-[#2B3139] relative overflow-hidden mb-6">
                        <div className="text-[#848E9C] text-xs font-medium uppercase mb-4 flex items-center gap-3">
                            <Activity className="w-4 h-4 text-[#F0B90B]" />
                            <span>Active Positions</span>
                            <span className="hidden md:flex items-center gap-2 ml-2 normal-case">
                                <span className="text-[10px] text-[#848E9C]">Lev</span>
                                <span className="text-[10px] font-mono text-[#EAECEF]">{leverageValue}x</span>
                                <input
                                    type="range"
                                    min={1}
                                    max={10}
                                    step={1}
                                    value={leverageValue}
                                    onChange={(e) => {
                                        setLevSource('user');
                                        setLeverageValue(Math.max(1, Math.min(10, parseInt(e.target.value || '1', 10) || 1)));
                                    }}
                                    className="w-40 h-2 accent-[#F0B90B]"
                                    aria-label="Leverage Limit"
                                />
                                <input
                                    type="number"
                                    min={1}
                                    max={10}
                                    value={leverageValue}
                                    onChange={(e) => {
                                        const v = parseInt(e.target.value || '1', 10);
                                        const clamped = Math.max(1, Math.min(10, isNaN(v) ? 1 : v));
                                        setLevSource('user');
                                        setLeverageValue(clamped);
                                    }}
                                    className="w-12 bg-[#0E1117] border border-[#2B3139] rounded px-1 py-0.5 text-[10px] text-center text-[#EAECEF]"
                                    aria-label="Leverage Number Input"
                                />
                                <button
                                    onClick={async () => {
                                        try {
                                            setSavingLev(true);
                                            setLevMsg('');
                                            const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';
                                            const currentCfg = (systemStatus && systemStatus.strategy && systemStatus.strategy.config) ? systemStatus.strategy.config : {};
                                            const payload = {
                                                ema_period: currentCfg.ema_period ?? 200,
                                                rsi_period: currentCfg.rsi_period ?? 14,
                                                ml_threshold: currentCfg.ml_threshold ?? 0.8,
                                                leverage: currentCfg.leverage ?? 1,
                                                max_portfolio_leverage: Math.max(1, Math.min(10, leverageValue))
                                            };
                                            await axios.post(`${API_URL}/api/v1/config/strategy`, payload, { timeout: 10000 });
                                            try { localStorage.setItem('strategyLeverage', String(Math.max(1, Math.min(10, leverageValue)))); } catch {}
                                            setLevMsg('已保存');
                                            await fetchStatus();
                                        } catch (e) {
                                            setLevMsg('保存失败');
                                        } finally {
                                            setSavingLev(false);
                                            setTimeout(() => setLevMsg(''), 2000);
                                        }
                                    }}
                                    disabled={savingLev}
                                    className={`px-2 py-0.5 rounded text-[10px] ${savingLev ? 'bg-[#2B3139] text-[#848E9C]' : 'bg-[#474D57] hover:bg-[#59606D] text-white'}`}
                                    aria-label="Save Leverage"
                                >
                                    {savingLev ? '...' : 'Save'}
                                </button>
                                {levMsg && <span className="text-[10px] text-[#848E9C]">{levMsg}</span>}
                            </span>
                        </div>
                        
                        {trader?.positions && Object.keys(trader.positions).length > 0 ? (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {Object.entries(trader.positions)
                                    .sort(([, a], [, b]) => b.unrealized_pnl - a.unrealized_pnl)
                                    .map(([symbol, pos]) => {
                                    const posPnlColor = pos.unrealized_pnl >= 0 ? 'text-[#0ECB81]' : 'text-[#F6465D]';
                                    const posPnlSign = pos.unrealized_pnl >= 0 ? '+' : '';
                                    const leverage = pos.leverage || 1;
                                    const roiVal = pos.pnl_pct; 
                                    const displaySymbol = symbol.replace(':USDT', '');

                                    return (
                                        <div key={symbol} className="flex flex-col gap-2 bg-[#2B3139]/20 p-3 rounded-lg border border-[#2B3139]/50 shadow-sm hover:border-[#F0B90B]/50 transition-colors duration-200">
                                            <div className="flex items-center justify-between border-b border-[#2B3139] pb-2">
                                                <div className="flex items-center gap-2">
                                                    <span className={`px-1.5 py-0.5 text-[10px] font-bold rounded ${pos.side === 'long' ? 'bg-[#0ECB81]/20 text-[#0ECB81]' : 'bg-[#F6465D]/20 text-[#F6465D]'}`}>
                                                        {pos.side === 'long' ? 'LONG' : 'SHORT'}
                                                    </span>
                                                    <span className="font-bold text-sm text-[#EAECEF]">{displaySymbol}</span>
                                                    <span className="text-[10px] text-[#848E9C] bg-[#2B3139] px-1 rounded">
                                                        {leverage}X
                                                    </span>
                                                    <span className="text-[10px] text-[#EAECEF] bg-[#2B3139] px-1 rounded" title="Total Position Value">
                                                        ${pos.position_value_usdt ? pos.position_value_usdt.toFixed(0) : '0'}
                                                    </span>
                                                </div>
                                                <div className={`text-sm font-bold font-mono ${posPnlColor}`}>
                                                    {posPnlSign}{pos.unrealized_pnl.toFixed(2)} ({posPnlSign}{roiVal.toFixed(2)}%)
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-4 gap-2 text-[10px] mb-2">
                                                <div>
                                                    <p className="text-[#848E9C]">Entry</p>
                                                    <p className="font-mono text-[#EAECEF]">{pos.entry_price.toFixed(2)}</p>
                                                </div>
                                                <div>
                                                    <p className="text-[#848E9C]">Mark</p>
                                                    <p className="font-mono text-[#EAECEF]">{pos.mark_price ? pos.mark_price.toFixed(2) : '-'}</p>
                                                </div>
                                                <div>
                                                    <p className="text-[#848E9C]">SL</p>
                                                    <p className="font-mono text-[#F6465D]">{pos.sl_price ? pos.sl_price.toFixed(2) : '-'}</p>
                                                </div>
                                                <div>
                                                    <p className="text-[#848E9C]">TP</p>
                                                    <p className="font-mono text-[#0ECB81]">{pos.tp_price ? pos.tp_price.toFixed(2) : '-'}</p>
                                                </div>
                                            </div>
                                            <div className="text-[10px] border-t border-[#2B3139] pt-2 flex justify-between items-center">
                                                <span className="text-[#848E9C]">Entry Time</span>
                                                <span className="font-mono text-[#EAECEF]">
                                                    {pos.entry_time 
                                                        ? new Date(pos.entry_time).toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })
                                                        : '-'}
                                                </span>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        ) : (
                            <div className="flex items-center justify-center h-16 text-[#848E9C] gap-2">
                                <Shield className="w-5 h-5 opacity-50" />
                                <span className="text-xs">No Active Position</span>
                            </div>
                        )}
                    </div>

                    {/* Trade History & Strategy Logs & News Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {/* Recent Trades */}
                        <div className="bg-[#1E2329] rounded-xl border border-[#2B3139] overflow-hidden h-[400px] flex flex-col shadow-md">
                            <div className="p-4 border-b border-[#2B3139] flex items-center justify-between bg-[#1E2329]">
                                <h2 className="font-semibold text-sm flex items-center gap-2 text-[#EAECEF]">
                                    <History className="w-4 h-4 text-[#F0B90B]" />
                                    Recent Trades (Closed)
                                </h2>
                            </div>
                            <div className="overflow-y-auto flex-1">
                                <table className="w-full text-xs text-left">
                                    <thead className="bg-[#2B3139]/50 text-[#848E9C] sticky top-0">
                                        <tr>
                                            <th className="px-3 py-2 font-medium">Entry Time (CN)</th>
                                            <th className="px-3 py-2 font-medium">Exit Time (CN)</th>
                                            <th className="px-3 py-2 font-medium">Duration</th>
                                            <th className="px-3 py-2 font-medium">Symbol</th>
                                            <th className="px-3 py-2 font-medium">Side</th>
                                            <th className="px-3 py-2 font-medium text-right">Entry</th>
                                            <th className="px-3 py-2 font-medium text-right">Exit</th>
                                            <th className="px-3 py-2 font-medium text-right">ROI</th>
                                            <th className="px-3 py-2 font-medium text-right">PnL</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-[#2B3139]">
                                        {trader?.trade_history && trader.trade_history.length > 0 ? (
                                            trader.trade_history.map((trade) => {
                                                // Only show closed trades (those with PnL and Entry/Exit info)
                                                if (!trade.realized_pnl || trade.realized_pnl === 0) return null;
                                                
                                                const isWin = (trade.realized_pnl || 0) > 0;
                                                const pnlColor = isWin ? 'text-[#0ECB81]' : 'text-[#F6465D]';
                                                // Use calculated position side if available, otherwise infer from exit side
                                                const positionSide = trade.position_side || (trade.side === 'sell' ? 'LONG' : 'SHORT');
                                                const sideColor = positionSide === 'LONG' ? 'text-[#0ECB81]' : 'text-[#F6465D]';
                                                
                                                // Calculate Duration
                                                const entryTime = (trade as any).entry_time;
                                                const exitTime = trade.timestamp;
                                                let durationDisplay = '-';
                                                if (entryTime && exitTime) {
                                                    const diff = exitTime - entryTime;
                                                    const hours = diff / (1000 * 60 * 60);
                                                    durationDisplay = hours.toFixed(1) + 'h';
                                                }

                                                return (
                                                    <tr key={trade.id} className="hover:bg-[#2B3139]/30 transition-colors">
                                                        <td className="px-3 py-2 font-mono text-[#EAECEF]">
                                                            {entryTime ? new Date(entryTime).toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : '-'}
                                                        </td>
                                                        <td className="px-3 py-2 font-mono text-[#EAECEF]">
                                                            {new Date(trade.datetime).toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}
                                                        </td>
                                                        <td className="px-3 py-2 font-mono text-[#EAECEF]">
                                                            {durationDisplay}
                                                        </td>
                                                        <td className="px-3 py-2 font-bold text-[#EAECEF]">
                                                            {(trade.symbol || '-').replace(':USDT', '')}
                                                        </td>
                                                        <td className="px-3 py-2">
                                                            <span className={`font-bold ${sideColor}`}>
                                                                {positionSide}
                                                            </span>
                                                        </td>
                                                        <td className="px-3 py-2 text-right font-mono text-[#EAECEF]">
                                                            {trade.entry_price ? trade.entry_price.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 4}) : '-'}
                                                        </td>
                                                        <td className="px-3 py-2 text-right font-mono text-[#EAECEF]">
                                                            {trade.exit_price ? trade.exit_price.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 4}) : trade.price.toLocaleString()}
                                                        </td>
                                                        <td className={`px-3 py-2 text-right font-mono ${pnlColor}`}>
                                                            {trade.roi ? trade.roi.toFixed(2) : '0.00'}%
                                                        </td>
                                                        <td className={`px-3 py-2 text-right font-mono font-bold ${pnlColor}`}>
                                                            {trade.realized_pnl.toFixed(2)}
                                                        </td>
                                                    </tr>
                                                );
                                            })
                                        ) : (
                                            <tr>
                                                <td colSpan={9} className="px-3 py-8 text-center text-[#848E9C]">
                                                    No closed trades yet
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* Strategy Logs */}
                        <div className="bg-[#1E2329] rounded-xl border border-[#2B3139] overflow-hidden h-[400px] flex flex-col shadow-md">
                            <div className="p-4 border-b border-[#2B3139] flex items-center justify-between bg-[#1E2329]">
                                <h3 className="font-semibold text-sm flex items-center gap-2 text-[#EAECEF]">
                                    <Clock className="w-4 h-4 text-[#F0B90B]" />
                                    Strategy Signals (All Coins)
                                </h3>
                                <div className="flex gap-2">
                                    <input 
                                        type="text" 
                                        placeholder="Search Symbol" 
                                        className="bg-[#2B3139] text-xs text-[#EAECEF] px-2 py-1 rounded border border-[#474D57] focus:outline-none focus:border-[#F0B90B] w-24"
                                        onChange={(e) => setSignalSearch(e.target.value)}
                                    />
                                    <select 
                                        className="bg-[#2B3139] text-xs text-[#EAECEF] px-2 py-1 rounded border border-[#474D57] focus:outline-none focus:border-[#F0B90B]"
                                        onChange={(e) => setSignalFilter(e.target.value)}
                                    >
                                        <option value="ALL">All Signals</option>
                                        <option value="ACTION">Actionable</option>
                                        <option value="LONG">Long Only</option>
                                        <option value="SHORT">Short Only</option>
                                        <option value="HIGH_CONF">High Conf.</option>
                                    </select>
                                </div>
                            </div>
                            <div className="overflow-y-auto flex-1">
                                <table className="w-full text-xs text-left">
                                    <thead className="bg-[#2B3139]/50 text-[#848E9C] sticky top-0">
                                        <tr>
                                            <th className="px-3 py-2 font-medium">Symbol</th>
                                            <th className="px-3 py-2 font-medium">Signal</th>
                                            <th className="px-3 py-2 font-medium">Prob.</th>
                                            <th className="px-3 py-2 font-medium">RSI</th>
                                            <th className="px-3 py-2 font-medium">ADX</th>
                                            <th className="px-3 py-2 font-medium">MACD</th>
                                            <th className="px-3 py-2 font-medium text-right">Price</th>
                                            <th className="px-3 py-2 font-medium">Note</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-[#2B3139]">
                                        {signalsError ? (
                                            <tr>
                                                <td colSpan={8} className="px-3 py-8 text-center text-[#F6465D]">
                                                    {signalsError} <br/>
                                                    <button onClick={() => fetchStrategySignals()} className="mt-2 px-3 py-1 bg-[#2B3139] rounded text-xs hover:bg-[#363C45]">Retry</button>
                                                </td>
                                            </tr>
                                        ) : signalsLoading ? (
                                            <tr>
                                                <td colSpan={8} className="px-3 py-8 text-center text-[#848E9C]">
                                                    Loading signals...
                                                </td>
                                            </tr>
                                        ) : strategySignals.length === 0 ? (
                                            <tr>
                                                <td colSpan={8} className="px-3 py-8 text-center text-[#848E9C]">
                                                    No signals found
                                                </td>
                                            </tr>
                                        ) : filteredSignals.length === 0 ? (
                                            <tr>
                                                <td colSpan={8} className="px-3 py-8 text-center text-[#848E9C]">No matching signals</td>
                                            </tr>
                                        ) : (
                                            filteredSignals.map((signal, index) => {
                                                const isUp = signal.signal === 'LONG';
                                                const isDown = signal.signal === 'SHORT';
                                                const indicators = signal.strategy_result?.indicators;
                                                
                                                return (
                                                    <tr key={`${signal.symbol}-${index}`} className="hover:bg-[#2B3139]/30 border-b border-[#2B3139]/50">
                                                        <td className="px-3 py-2 font-bold text-[#EAECEF]">
                                                            {signal.symbol}
                                                            <span className="block text-[10px] text-[#848E9C] font-mono">
                                                                {signal.timestamp.split('T')[1]?.split('.')[0] || (signal.timestamp.includes(' ') ? signal.timestamp.split(' ')[1] : signal.timestamp)}
                                                            </span>
                                                        </td>
                                                        <td className="px-3 py-2">
                                                            <div className={`flex items-center gap-1 ${isUp ? 'text-[#0ECB81]' : (isDown ? 'text-[#F6465D]' : 'text-[#848E9C]')}`}>
                                                                {isUp ? <ArrowUp className="w-3 h-3" /> : (isDown ? <ArrowDown className="w-3 h-3" /> : <Activity className="w-3 h-3" />)}
                                                                <span className="font-bold">{signal.signal}</span>
                                                                {signal.confidence === 'HIGH' && <span className="ml-1 text-[8px] bg-[#F0B90B] text-black px-1 rounded">HC</span>}
                                                            </div>
                                                        </td>
                                                        <td className="px-3 py-2 font-mono text-[#EAECEF]">
                                                            {(signal.avg_probability * 100).toFixed(1)}%
                                                        </td>
                                                        <td className={`px-3 py-2 font-mono ${indicators?.rsi && (indicators.rsi > 70 || indicators.rsi < 30) ? 'text-[#F0B90B]' : 'text-[#EAECEF]'}`}>
                                                            {indicators?.rsi ? indicators.rsi.toFixed(1) : '-'}
                                                        </td>
                                                        <td className={`px-3 py-2 font-mono ${indicators?.adx && indicators.adx > 25 ? 'text-[#F0B90B]' : 'text-[#848E9C]'}`}>
                                                            {indicators?.adx ? indicators.adx.toFixed(1) : '-'}
                                                        </td>
                                                        <td className={`px-3 py-2 font-mono ${indicators?.macd_hist && indicators.macd_hist > 0 ? 'text-[#0ECB81]' : (indicators?.macd_hist && indicators.macd_hist < 0 ? 'text-[#F6465D]' : 'text-[#EAECEF]')}`}>
                                                            {indicators?.macd_hist ? indicators.macd_hist.toFixed(2) : '-'}
                                                        </td>
                                                        <td className="px-3 py-2 text-right font-mono text-[#EAECEF]">
                                                            {signal.price.toLocaleString()}
                                                            {indicators?.ema && <span className="text-[10px] text-[#848E9C] block">EMA:{indicators.ema.toFixed(0)}</span>}
                                                        </td>
                                                        <td className="px-3 py-2 text-xs text-[#848E9C] max-w-[200px] truncate" title={signal.strategy_result?.reason}>
                                                            {signal.strategy_result?.reason || '-'}
                                                        </td>
                                                    </tr>
                                                );
                                            })
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* News Card Removed from here */ }
                    </div>
                </div>

                {/* Backtest Panel */}
                {showBacktest && (
                    <BacktestPanel 
                        onClose={() => setShowBacktest(false)} 
                        onBacktestResult={handleBacktestResult}
                    />
                )}

                {/* Portfolio Panel */}
                {showPortfolio && (
                    <PortfolioPanel 
                        onClose={() => setShowPortfolio(false)} 
                        onSelectSymbol={(symbol) => {
                            console.log('Selected symbol:', symbol);
                            // Future: Switch current view to this symbol
                            setShowPortfolio(false);
                        }}
                    />
                )}
            </main>
        </div>
    );
}
