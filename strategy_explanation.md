# 策略说明文档 (Strategy Explanation)

## 核心策略：混合趋势 + 机器学习策略 (TrendMLStrategy)

本系统采用混合策略，结合了传统技术指标（EMA, RSI）与机器学习模型（XGBoost）的预测结果，旨在捕捉趋势并利用 ML 模型确认入场时机。

### 1. 信号生成逻辑 (Signal Logic)

交易信号由以下三个核心组件共同决定：

#### A. 趋势判断 (Trend)
- **Heikin Ashi (平均K线)**:
  - **平滑趋势**: 使用 Heikin Ashi 蜡烛图过滤市场噪音。
  - **看多**: HA阳线 (Close > Open) 且 HA Close > EMA200。
  - **看空**: HA阴线 (Close < Open) 且 HA Close < EMA200。
- **主趋势**: EMA200 (200周期指数移动平均线)
  - 价格 (HA Close) > EMA200 -> **上升趋势 (Uptrend)**
  - 价格 (HA Close) < EMA200 -> **下降趋势 (Downtrend)**
- **趋势增强 (Trend Strength)**: EMA50 (50周期指数移动平均线)
  - EMA50 > EMA200: 强多头排列
  - EMA50 < EMA200: 强空头排列
- **MACD (趋势动量)**:
  - MACD柱状图 (Histogram) > 0 且 递增 -> 金叉增强 (Bullish)
  - MACD柱状图 (Histogram) < 0 且 递减 -> 死叉增强 (Bearish)

#### B. 动量过滤 (Momentum)
- **指标**: RSI14 (14周期相对强弱指数)
- **逻辑**:
  - **做多条件**: RSI < 70 (避免超买区追高)
  - **做空条件**: RSI > 30 (避免超卖区追空)

#### C. 机器学习确认 (ML Confirmation)
- **模型**: XGBoost (多周期预测)
- **阈值**: 主阈值 0.75 (Confidence Threshold)
- **最新模型表现 (2026-02-08, 180天数据)**:
  - **30m 模型**: 高置信度准确率 **64.29%** (阈值 0.89) - 数据量增加，模型泛化能力增强。
  - **10m 模型**: 高置信度准确率 **56.92%** (阈值 0.81)
  - **60m 模型**: 高置信度准确率 **61.54%** (阈值 0.86)
  - **策略应用**: 优先采用 30m 模型信号，当 30m 模型预测概率 > 0.89 时触发高置信度信号。

### 2. 自适应多模式交易 (Adaptive Multi-Mode Trading) [NEW]

系统引入波动率识别模块，根据市场状态动态调整交易参数。

#### A. 波动率识别 (Volatility Classification)
- **指标**: ATR (20) 和 价格波动率 (Std Dev of Returns)
- **状态分类**:
  1. **低波动 (Low Volatility)**: ATR < 均值*0.7 且 波动率 < 0.8%
  2. **高波动 (High Volatility)**: ATR > 均值*1.3 或 波动率 > 1.5%
  3. **正常波动 (Normal Volatility)**: 其他情况

#### B. 模式参数 (Mode Parameters)
| 模式 | 仓位 (资金%) | 杠杆 (Leverage) | 止盈 (TP) | 止损 (SL) | 策略重点 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **低波动 (Scalp)** | 10-20% | 3-5x | 0.8-1.2% (固定) | 1.5-2% (固定) | 高频吃点，高ML阈值(>0.8) |
| **正常 (Trend)** | 30-50% | 8-12x | 2-3% 或 2*ATR | 1.5*ATR | 趋势+ML均衡 |
| **高波动 (Breakout)** | 70-90% | 15-20x | 4-6% 或 阻力位 | 1*ATR | 突破行情，宽止损抓大趋势 |

### 3. 风险管理 (Risk Management)

#### A. 动态止盈与保护 (Dynamic Profit Protection)
- **保本损 (Break-Even)**: 当浮盈 > 1% 时，止损上移至开仓价。
- **利润锁定 (Lock Profit)**: 当浮盈 > 3% 时，移动止损至开仓价 + 1%。
- **动态回撤止盈**:
  - 记录持仓期间最高价格 (Highest Price)。
  - 若从最高点回撤 > 1.5% 且当前仍盈利，触发立即止盈。

#### B. 仓位控制 (Position Control)
- **分批建仓**: 强信号(ML>0.8)时分批买入 (40/30/30)，降低平均成本风险。
- **单日风控**: 单日累计亏损超过总资金 2% 时，停止当日开新仓。
- **单品种限制**: 单个币种最大持仓不超过总资金 30% (高波动模式除外)。

#### C. 基础风控 (Basic Risk)
- **硬止损 (Hard SL)**: 交易所直接挂单，防止极端行情穿仓。
- **ReduceOnly**: 止损/止盈单强制使用只减仓模式，避免反向开仓。

### 4. 开仓逻辑 (Opening Logic)
- **信号触发**:
  - 系统实时（每 1-3 秒）扫描市场数据。
  - 当 TrendMLStrategy 生成 `1` (Long) 或 `-1` (Short) 信号时，触发开仓检查。
- **开仓条件**:
  - **无持仓**: 若当前该币种无持仓，则直接开仓。
  - **反向持仓**: 若当前持有反向仓位，则先平掉旧仓位，再开新仓位。
  - **同向持仓**: 若当前持有同向仓位，则保持持仓（不加仓，避免风险过度集中）。
- **订单执行**:
  - **市价单 (Market Order)**: 以当前市价立即成交。
  - **止损单 (Stop Loss)**: 开仓后立即下达交易所止损单 (STOP_MARKET)，价格由 ATR 动态计算。
  - **杠杆设置**: 开仓前自动调用交易所接口设置该币种的杠杆倍数。

### 5. 收益提升优化方案 (Profit Optimization Plan) [PLANNED]

为解决收益曲线瓶颈，计划实施以下优化：

#### A. ML模型优化
- **降低置信阈值**: 将主信号阈值从 0.89 调整至 0.75，以捕获更多交易机会，利用胜率换取频率。
- **集成学习**: 未来引入 LightGBM 和 CatBoost 与 XGBoost 组成投票机制。

#### B. 动态杠杆增强 (Dynamic Leverage)
- **逻辑升级**:
  - 基础杠杆提升至 5x-8x。
  - **高置信加成**: ML > 0.85 时，杠杆系数 * 1.8。
  - **趋势加成**: 趋势强度 > 0.7 时，杠杆系数 * 1.5。
  - **上限控制**: 最大杠杆限制在 30x。

#### C. 智能止损重构 (Adaptive Stop Loss)
- **宽松止损**: 高置信度信号时，将止损放宽至 2.5 * ATR (原 1.5 * ATR)，避免被噪音扫损。
- **快速保本**: 盈利超过 2% 后立即触发保本止损。

#### D. 信号频率提升
- **高频扫描**: 优化数据采集频率，从 1-3秒/次 提升至 500ms/次。
- **微观结构**: 未来加入买卖单流失衡 (Order Flow Imbalance) 作为辅助信号。

### 6. 激进排行榜交易模式 (Aggressive Leaderboard Trading) [NEW]

为捕捉市场热点，系统新增了排行榜激进交易模式。

#### A. 扫描机制
- **范围**: 全市场 USDT 永续合约。
- **筛选**: 24小时涨跌幅榜前 5 名 + 交易量过滤 (>1000万 USDT)。
- **动态接入**: 即使不在核心 30 币种列表中，也会临时接入进行分析。

#### B. 信号逻辑 (纯技术面)
由于新币种缺乏 ML 模型训练数据，采用**严格技术面确认**：
- **做多**: Heikin Ashi 阳线 + 价格 > EMA200 + 成交量放大 (1.5x) + RSI (30-85)。
- **做空**: Heikin Ashi 阴线 + 价格 < EMA200 + 成交量放大 (1.5x) + RSI (15-70)。

#### C. 风控
- **小仓位**: 激进模式默认使用较小仓位。
- **保守杠杆**: 初始杠杆限制在 10x。

### 7. 优化进展 (Optimization Progress)

#### A. 已完成 (Completed)
1. **策略迭代**:
   - **Heikin Ashi 集成**: 已在 TrendMLStrategy 中实现 HA 蜡烛图计算及信号逻辑。
   - **动态杠杆**: 实现了基于 ML 置信度、趋势强度和成交量的动态杠杆调整。
   - **多模式自适应**: 引入波动率分类，针对不同行情采用不同杠杆和止盈止损策略。
2. **数据准备**:
   - **FuturesDataCollector**: 完成了期货数据采集。
   - **模型重训练**: 使用最新的期货数据重新训练了 XGBoost 模型。
3. **系统修复**:
   - **SL/TP 修复**: 解决了止盈止损单在交易所不显示的问题 (Algo Orders)。
   - **前端连接**: 修复了 API 连接问题。

#### B. 策略参考 (GitHub References)
参考开源优秀的 BTC 合约量化策略进行迭代：
1. **Hephyrius/binance_futures_bot (TalonSniper)**:
   - [已采纳] 使用 Heikin Ashi 蜡烛图平滑噪音。
   - [已采纳] 采用多时间周期共振 (10m, 30m)。
2. **Erfaniaa/binance-futures-trading-bot**:
   - [已采纳] 混合策略思路 (Trend + ML)。
3. **conor19w/Binance-Futures-Trading-Bot**:
   - [已采纳] 移动止损 (Trailing Stop) 逻辑。

---
*文档更新时间: 2026-02-10*
