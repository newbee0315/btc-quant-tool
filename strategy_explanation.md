# 策略说明文档 (Strategy Explanation)

## 核心策略：混合趋势 + 机器学习策略 (TrendMLStrategy)

本系统采用混合策略，结合了传统技术指标（EMA, RSI）与机器学习模型（XGBoost）的预测结果，旨在捕捉趋势并利用 ML 模型确认入场时机。

### 1. 信号生成逻辑 (Signal Logic)

交易信号由以下四个核心组件共同决定（新增缠论模式识别）：

#### A. 趋势判断 (Trend)
- **Heikin Ashi (平均K线)**:
  - **平滑趋势**: 使用 Heikin Ashi 蜡烛图过滤市场噪音。
  - **看多**: HA阳线 (Close > Open) 且 HA Close > EMA200。
  - **看空**: HA阴线 (Close < Open) 且 HA Close < EMA200。
- **主趋势**: EMA200 (200周期指数移动平均线)
  - 价格 (HA Close) > EMA200 -> **上升趋势 (Uptrend)**
  - 价格 (HA Close) < EMA200 -> **下降趋势 (Downtrend)**
- **趋势增强 (Trend Strength)**: EMA50 (50周期指数移动平均线)
  - EMA50 > EMA200: 强多头排列
  - EMA50 < EMA200: 强空头排列
- **MACD (趋势动量)**:
  - MACD柱状图 (Histogram) > 0 且 递增 -> 金叉增强 (Bullish)
  - MACD柱状图 (Histogram) < 0 且 递减 -> 死叉增强 (Bearish)

#### B. 动量过滤 (Momentum)
- **指标**: RSI14 (14周期相对强弱指数)
- **逻辑**:
  - **做多条件**: RSI < 70 (避免超买区追高)
  - **做空条件**: RSI > 30 (避免超卖区追空)

#### C. 机器学习确认 (ML Confirmation)
- **模型**: XGBoost (多周期预测)
- **阈值**: 主阈值 0.75 (Confidence Threshold)
- **最新模型表现 (2026-02-08, 180天数据)**:
  - **30m 模型**: 高置信度准确率 **64.29%** (阈值 0.89) - 数据量增加，模型泛化能力增强。
  - **10m 模型**: 高置信度准确率 **56.92%** (阈值 0.81)
  - **60m 模型**: 高置信度准确率 **61.54%** (阈值 0.86)
  - **策略应用**: 优先采用 30m 模型信号，当 30m 模型预测概率 > 0.89 时触发高置信度信号。

#### D. 缠论模式识别 (Chanlun Pattern Recognition) [NEW - CZSC集成]
- **技术来源**: 基于CZSC开源项目的缠论分析框架 (v0.10.10 Rust版本)
- **多时间框架分析**: 同时分析5分钟、30分钟、1小时K线数据
- **分型识别 (Fenxing)**:
  - **顶分型**: 中间K线最高价最高，最低价最高 -> 潜在反转信号
  - **底分型**: 中间K线最低价最低，最高价最低 -> 潜在反转信号
  - **强度评估**: 基于分型位置和成交量确认信号强度
- **笔识别 (Bi)**:
  - **上涨笔**: 连续上涨K线序列，识别趋势方向
  - **下跌笔**: 连续下跌K线序列，识别趋势方向
  - **笔长度**: 评估趋势持续性和强度
- **中枢识别 (Zhongshu)**:
  - **震荡区域**: 价格波动范围 < 2% -> 中枢整理区域
  - **突破信号**: 价格脱离中枢区域 + 趋势确认 -> 强烈交易信号
  - **中枢强度**: 基于中枢持续时间和价格波动范围
- **背驰分析 (Divergence)**:
  - **顶背驰**: 价格创新高但动量减弱 -> 潜在反转信号
  - **底背驰**: 价格创新低但动量减弱 -> 潜在反转信号
- **买卖点逻辑**:
  - **第一类买点**: 底分型 + 趋势向上确认 + 底背驰信号
  - **第一类卖点**: 顶分型 + 趋势向下确认 + 顶背驰信号  
  - **第二类买点**: 回调至中枢下沿 + 底分型确认
  - **第三类买点**: 突破中枢上沿回踩确认 + 趋势向上

#### E. 策略验证与回测结果 (Strategy Verification) [NEW - 2026.02.11 Final Optimized v2]
- **测试环境**: 14天 BTCUSDT 5分钟K线数据 (2026年1月底-2月初)
- **优化重点**: 
  1. **参数调优**: 提高 ML 阈值 (反转 >0.70/<0.30)。
  2. **信号过滤**: 引入 ADX 指标过滤弱趋势。
  3. **风控强化**: 基于 ATR 波动率的动态风险调整 (高波动降低仓位风险)。
- **对比测试**:
  | 指标 | 基础策略 (No CZSC) | 增强策略 (With CZSC + ADX + Dynamic Risk) | 变化 |
  | :--- | :--- | :--- | :--- |
  | **最终余额** | 908.90 USDT | 875.30 USDT | -33.60 USDT |
| **交易次数** | 77 | 85 | +8 |
| **胜率** | 38.96% | **40.00%** | **+1.04%** |
| **最大回撤** | 35.57% | **31.27%** | **-4.30% (生存能力提升)** |
- **结论**:
  - **抗风险能力**: 引入 CZSC 和 10x 杠杆限制后，最大回撤控制在 31% 左右，优于基础策略。
  - **胜率突破**: 胜率达到 40%，表明信号质量有所提升。
  - **注意**: 尽管回撤降低，但净利润略有下降，主要源于更多的交易带来了更高的手续费成本。

### 2. 自适应多模式交易 (Adaptive Multi-Mode Trading) [NEW]

系统引入波动率识别模块，根据市场状态动态调整交易参数。

#### A. 波动率识别 (Volatility Classification)
- **指标**: ATR (20) 和 价格波动率 (Std Dev of Returns)
- **状态分类**:
  1. **低波动 (Low Volatility)**: ATR < 均值*0.7 且 波动率 < 0.8%
  2. **高波动 (High Volatility)**: ATR > 均值*1.3 或 波动率 > 1.5%
  3. **正常波动 (Normal Volatility)**: 其他情况

#### B. 模式参数 (Mode Parameters)
| 模式 | 风险上限 (Risk/Trade) | 杠杆 (Leverage) | 止盈 (TP) | 止损 (SL) | 策略重点 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **低波动 (Scalp)** | 2.0% | **10x (Max)** | 0.5% (固定) | Max(6.0*ATR, 2%) | 高频吃点，极宽止损(高胜率模式) |
| **正常 (Trend)** | 2.0% | **10x (Max)** | 4.0*ATR | Max(3.0*ATR, 2%) | 趋势+ML均衡 |
| **高波动 (Breakout)** | 1.0-1.5% | **10x (Max)** | 6.0*ATR | Max(3.0*ATR, 2%) | 突破行情，宽止盈持仓 |

### 3. 资金管理规则 (Money Management Rules) [NEW]
- **最小开仓金额**: 150 USDT (单笔交易名义价值)
- **止损限制**: 亏损幅度至少 2% 才触发止损 (避免被微小波动扫损)
- **杠杆限制**: 全局最大 **10x**
- **总仓位限制**: 最大总持仓价值不超过本金的 **10倍** (Max Total Position Value ≤ 10 × Equity)
- **单币上限**: 单一币种名义价值不超过本金的 **3倍** (Per-Coin Notional ≤ 3 × Equity)
- **同向净敞口上限**: 多/空任一方向名义价值合计不超过本金的 **6倍** (Same-Side Notional ≤ 6 × Equity)
- **相关性过滤**: 新开仓与当前持仓同向币种的相关系数 > **0.65** 时拒绝开仓（分散风险，避免同质化敞口）

### 3. 风险管理 (Risk Management)

#### A. 动态止盈与保护 (Dynamic Profit Protection)
- **保本损 (Break-Even)**: 当浮盈 > 1% 时，止损上移至开仓价。
- **利润锁定 (Lock Profit)**: 当浮盈 > 3% 时，移动止损至开仓价 + 1%。
- **动态回撤止盈**:
  - 记录持仓期间最高价格 (Highest Price)。
  - 若从最高点回撤 > 1.5% 且当前仍盈利，触发立即止盈。

#### B. 仓位控制 (Position Control) - [NEW - Risk Based Sizing]
- **基于风险的仓位计算 (Risk-Based Sizing)**: 
  - 放弃传统的固定资金比例开仓，改为基于单笔交易风险金额计算仓位。
  - **公式**: `仓位价值 = (总资金 * 单笔风险%) / (止损距离%)`
  - **基础风险**: 单笔交易最大亏损不超过总资金的 **2%**。
  - **动态调整**:
    - **高波动 (ATR > 2%)**: 风险降至 **1.5%**。
    - **极端波动 (ATR > 4%)**: 风险降至 **1.0%**。
    - **反转交易 (Counter-Trend)**: 风险限制在 **1.5%** 以内。
- **单日风控**: 单日累计亏损超过总资金 2% 时，停止当日开新仓。
- **杠杆限制**: 根据计算出的仓位价值自动匹配杠杆，最大不超过 **10x** (用户自定义限制)。

#### C. 基础风控 (Basic Risk)
- **硬止损 (Hard SL)**: 交易所直接挂单，防止极端行情穿仓。
- **ReduceOnly**: 止损/止盈单强制使用只减仓模式，避免反向开仓。

### 4. 开仓逻辑 (Opening Logic)
- **信号触发**:
  - 系统实时（每 1-3 秒）扫描市场数据。
  - 当 TrendMLStrategy 生成 `1` (Long) 或 `-1` (Short) 信号时，触发开仓检查。
- **开仓条件**:
  - **无持仓**: 若当前该币种无持仓，则直接开仓。
  - **反向持仓**: 若当前持有反向仓位，则先平掉旧仓位，再开新仓位。
  - **同向持仓**: 若当前持有同向仓位，则保持持仓（不加仓，避免风险过度集中）。
- **订单执行**:
  - **市价单 (Market Order)**: 以当前市价立即成交。
  - **止损单 (Stop Loss)**: 开仓后立即下达交易所止损单 (STOP_MARKET)，价格由 ATR 动态计算。
  - **杠杆设置**: 开仓前自动调用交易所接口设置该币种的杠杆倍数。

### 5. 收益提升优化方案 (Profit Optimization Plan) [PLANNED]

为解决收益曲线瓶颈，计划实施以下优化：

#### A. ML模型优化
- **降低置信阈值**: 将主信号阈值从 0.89 调整至 0.75，以捕获更多交易机会，利用胜率换取频率。
- **集成学习**: 未来引入 LightGBM 和 CatBoost 与 XGBoost 组成投票机制。

#### B. 动态杠杆增强 (Dynamic Leverage)
- **逻辑升级**:
  - 基础杠杆提升至 5x-8x。
  - **高置信加成**: ML > 0.85 时，杠杆系数 * 1.8。
  - **趋势加成**: 趋势强度 > 0.7 时，杠杆系数 * 1.5。
  - **上限控制**: 最大杠杆限制在 10x。

#### C. 智能止损重构 (Adaptive Stop Loss)
- **宽松止损**: 高置信度信号时，将止损放宽至 2.5 * ATR (原 1.5 * ATR)，避免被噪音扫损。
- **快速保本**: 盈利超过 2% 后立即触发保本止损。

#### D. 信号频率提升
- **高频扫描**: 优化数据采集频率，从 1-3秒/次 提升至 500ms/次。
- **微观结构**: 未来加入买卖单流失衡 (Order Flow Imbalance) 作为辅助信号。

### 6. 激进排行榜交易模式 (Aggressive Leaderboard Trading) [NEW]

为捕捉市场热点，系统新增了排行榜激进交易模式。

#### A. 扫描机制
- **范围**: 全市场 USDT 永续合约。
- **筛选**: 24小时涨跌幅榜前 5 名 + 交易量过滤 (>1000万 USDT)。
- **动态接入**: 即使不在核心 30 币种列表中，也会临时接入进行分析。

#### B. 信号逻辑 (纯技术面)
由于新币种缺乏 ML 模型训练数据，采用**严格技术面确认**：
- **做多**: Heikin Ashi 阳线 + 价格 > EMA200 + 成交量放大 (1.5x) + RSI (30-85)。
- **做空**: Heikin Ashi 阴线 + 价格 < EMA200 + 成交量放大 (1.5x) + RSI (15-70)。

#### C. 风控
- **小仓位**: 激进模式默认使用较小仓位。
- **保守杠杆**: 初始杠杆限制在 10x。

### 7. 优化进展 (Optimization Progress)

#### A. 已完成 (Completed)
1. **策略迭代**:
   - **Heikin Ashi 集成**: 已在 TrendMLStrategy 中实现 HA 蜡烛图计算及信号逻辑。
   - **动态杠杆**: 实现了基于 ML 置信度、趋势强度和成交量的动态杠杆调整。
   - **多模式自适应**: 引入波动率分类，针对不同行情采用不同杠杆和止盈止损策略。
2. **数据准备**:
   - **FuturesDataCollector**: 完成了期货数据采集。
   - **模型重训练**: 使用最新的期货数据重新训练了 XGBoost 模型。
3. **系统修复**:
   - **SL/TP 修复**: 解决了止盈止损单在交易所不显示的问题 (Algo Orders)。
   - **前端连接**: 修复了 API 连接问题。

#### B. 策略参考 (GitHub References)
参考开源优秀的 BTC 合约量化策略进行迭代：
1. **Hephyrius/binance_futures_bot (TalonSniper)**:
   - [已采纳] 使用 Heikin Ashi 蜡烛图平滑噪音。
   - [已采纳] 采用多时间周期共振 (10m, 30m)。
2. **Erfaniaa/binance-futures-trading-bot**:
   - [已采纳] 混合策略思路 (Trend + ML)。
3. **conor19w/Binance-Futures-Trading-Bot**:
   - [已采纳] 移动止损 (Trailing Stop) 逻辑。

### 8. 最新优化 (Latest Optimization - 2026.02.13)

针对多币种策略的进一步增强，主要集中在风险控制、模型特征和执行算法：

#### A. 风险控制：币种相关性矩阵 (Correlation Matrix)
- **背景**: 避免同时持有高度正相关的币种（如 BTC 和 ETH 同时做多），导致风险敞口同质化。
- **机制**:
  - 引入 `CorrelationManager` 模块，实时计算过去 100 个周期（1m K线）的价格相关性矩阵。
  - **开仓过滤**: 在开新仓位前，检查该币种与当前持仓中同方向（同多或同空）币种的相关系数。
  - **阈值**: 若相关系数 > **0.65**，则视为高风险同质化交易，系统自动拒绝开仓。

#### B. 机器学习模型迭代：微观结构特征 (Microstructure Features)
- **特征工程增强**: 在原有技术指标基础上，新增 4 类市场微观结构特征，提升模型对流动性和波动率的感知：
  1. **Amihud Illiquidity (非流动性指标)**: 衡量单位成交量带来的价格冲击，捕捉流动性枯竭风险。
  2. **Parkinson Volatility (帕金森波动率)**: 基于 High-Low 极差计算的波动率，比传统 Close-Close 标准差更灵敏。
  3. **Effective Spread Proxy (有效价差代理)**: (High - Low) / Close，估算市场买卖价差成本。
  4. **Volume Volatility (成交量波动率)**: 成交量的标准差/均值，识别成交量异动。

#### C. 执行算法优化：TWAP (时间加权平均价格)
- **背景**: 减少大额订单对市场的冲击及滑点成本。
- **逻辑**:
  - **阈值**: 当单笔订单名义价值 > **5,000 USDT** 时触发。
  - **拆单**: 自动将订单拆分为 3 笔子订单。
  - **执行**: 每笔子订单间隔 2 秒执行，平滑入场成本。

### 9. 策略优化与执行 (Optimization & Execution - 2026.02.23) [NEW]

为实现 "一年从 214U 到 10,000U" 的目标，我们实施了以下关键优化，旨在保证高胜率的同时利用复利效应：

#### A. 盈亏比修正 (R:R Ratio Fix)
- **核心逻辑**: 坚决执行 **1:2** 的盈亏比，确保每一笔交易的潜在收益是风险的两倍。
- **参数**:
  - **止损 (SL)**: 严格控制在 **1.5% - 2%**。一旦触及，立即离场，绝不扛单。
  - **止盈 (TP)**: 目标设定为 **3% - 4%**。

#### B. 动态仓位管理 (Dynamic Position Sizing)
- **逻辑**: 放弃固定金额开仓，采用 **动态复利** 模式。
- **比例**: 单笔交易仓位为 **当前总权益的 15%** (15% Equity)。
- **效果**: 随着账户资金增长，单笔投入自动增加；若账户回撤，投入自动减少，天然具备抗风险能力。

#### C. 分批止盈与利润奔跑 (Partial TP & Trailing)
- **分批机制**:
  - 当持仓收益达到 **3%** 时，自动 **平仓 50%**。锁定一半利润，确保该笔交易即使后续回调也不会亏损。
  - 剩余 **50%** 仓位开启 **移动止损 (Trailing Stop)**，让利润奔跑，捕捉潜在的大趋势。

#### D. 标的聚焦 (Focus on 14 Selected Coins)
- **范围**: 仅交易流动性最好的 **14** 个币种 (`BTC`, `ETH`, `SOL`, `BNB`, `DOGE`, `XRP`, `PEPE`, `AVAX`, `LINK`, `ADA`, `TRX`, `LDO`, `BCH`, `OPN`)。
- **目的**: 覆盖更多高波动机会，同时避免小币种的流动性枯竭和“插针”风险，提高技术分析的有效性。

#### E. 资金增长模拟 (Simulation)
- **初始资金**: ~210 USDT (权益)
- **目标资金**: 10,000 USDT (2026年底)
- **日均目标**: ~1.26%
- **策略**: 通过多币种（14个）轮动和高盈亏比（1:2）交易，利用复利效应实现指数级增长。
- **关键**: 保持耐心，严格执行 2% 止损，控制回撤，时间是最好的朋友。

---
*文档更新时间: 2026-02-24*
